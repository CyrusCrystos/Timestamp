name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate analysis

      - name: Download SonarScanner
        run: |
          $version = "5.0.1.3006"
          $url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$version-windows.zip"
          Invoke-WebRequest -Uri $url -OutFile sonar-scanner.zip
          Expand-Archive -Path sonar-scanner.zip -DestinationPath .
          Rename-Item -Path "sonar-scanner-$version-windows" -NewName "sonar-scanner"

      - name: Add SonarScanner to PATH
        run: |
          $scannerPath = (Resolve-Path "sonar-scanner\bin").Path
          echo "::add-path::$scannerPath"

      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # Must match your GitHub secret name
        run: |
          sonar-scanner.bat `
            -D"sonar.organization=cyruscrystos" `
            -D"sonar.projectKey=CyrusCrystos_TimeStamping" `
            -D"sonar.sources=." `
            -D"sonar.host.url=https://sonarcloud.io"
